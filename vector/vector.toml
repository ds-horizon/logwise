# Vector.dev configuration for log endpoint service
# Replaces the Flask app for receiving OTLP logs from OTEL collector


# below api config is used for healthcheck
[api]
enabled = true
address = "0.0.0.0:8686"
playground = false

# OpenTelemetry source to receive logs from OTEL collector  
[sources.otlp_logs]
type = "opentelemetry"

# Not getting used but it is a required config for opentelemetry
[sources.otlp_logs.grpc]
address = "0.0.0.0:4317"

[sources.otlp_logs.http]
address = "0.0.0.0:4318"


# Transform to enrich OTLP data with additional metadata
[transforms.enrich_otlp]
type = "remap"
inputs = ["otlp_logs.logs"]
drop_on_abort = true
source = '''

if !is_string(.resources."service.name") { abort }
if !is_string(.resources.environment)    { abort }
if !is_string(.resources.type)    { abort }


# Normalize as strings (infallible)
.service_name     = to_string(.resources."service.name") ?? "unknown"
.environment_name = to_string(.resources.environment)    ?? "unknown"
.type = to_string(.resources.type)    ?? "unknown"


# sanitize service_name and environment_name
.service_name = replace(.service_name, r'[^a-zA-Z0-9._-]', "_")
.environment_name = replace(.environment_name, r'[^a-zA-Z0-9._-]', "_")
.type = replace(.type, r'[^a-zA-Z0-9._-]', "_")

# Handle attributes with fallible assignments and defaults
.message    = to_string(.attributes.message) ?? "no_message"
.log_level  = to_string(.attributes.level) ?? "unknown"
.timestamp  = to_string(.attributes.time) ?? "unknown"

'''

[sinks.app-logs-kafka]
type = "kafka"
inputs = [ "enrich_otlp" ]
bootstrap_servers = "kafka:29092"
topic = "logs.{{.type}}_{{.environment_name}}_{{.service_name}}"
compression = "zstd"

# Protobuf codec - Only .desc file needed at runtime
# Note: protoc is build-time only; runtime can be distroless if .desc is baked in
encoding.codec = "protobuf"
encoding.protobuf.message_type = "logwise.vector.logs.VectorLogs"
encoding.protobuf.desc_file = "/etc/vector/logwise-vector.desc"

[sinks.app-logs-kafka.librdkafka_options]
"linger.ms" = "100"
"batch.size" = "2500000"