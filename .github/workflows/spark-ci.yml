name: Spark CI

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    paths:
      - 'spark/**'
      - '.github/workflows/spark-ci.yml'
  workflow_dispatch:

jobs:
  spark-checks:
    name: Spark Checks (Format, Test, SonarCloud)
    runs-on: ubuntu-latest
    steps:
      # ============================================================================
      # Setup Steps
      # ============================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones disabled for better SonarCloud analysis

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('spark/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # ============================================================================
      # 1. Code Formatting Check
      # ============================================================================
      - name: Verify code formatting
        working-directory: spark
        run: mvn -B fmt:check

      # ============================================================================
      # 2. Build, Test, and Coverage Check
      # ============================================================================
      - name: Build, run tests, and check coverage
        working-directory: spark
        run: mvn clean verify -B
        # This single command:
        # - Compiles the project
        # - Runs unit tests (with JaCoCo coverage)
        # - Runs integration tests (with JaCoCo coverage)
        # - Generates coverage reports
        # - Checks coverage thresholds (fails if not met):
        #   * Line coverage: 80%
        #   * Branch coverage: 75%
        #   * Method coverage: 80%

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: spark/target/site/jacoco/
          retention-days: 7

      # ============================================================================
      # 3. SonarCloud/SonarQube Analysis
      # ============================================================================
      # IMPORTANT: Coverage Report Flow
      # 1. The previous step (mvn clean verify) runs JaCoCo plugin which:
      #    - Instruments code during test execution
      #    - Generates coverage data in target/site/jacoco/jacoco.xml
      # 2. Sonar scanner (mvn sonar:sonar) automatically reads this file from:
      #    - Default location: target/site/jacoco/jacoco.xml
      #    - Configured via: sonar.java.coveragePlugin=jacoco (in sonar-project.properties)
      # 3. Sonar uploads coverage data along with code analysis to SonarCloud/SonarQube
      # 4. Coverage metrics appear in Sonar dashboard
      # - name: SonarCloud Scan
      #   working-directory: spark
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Automatically provided by GitHub Actions
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Must be set in repository secrets
      #     SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}  # Optional: Set if SonarCloud doesn't auto-detect
      #     # Sonar server endpoint configuration
      #     # REQUIRED: Set SONAR_HOST_URL secret in GitHub: Settings → Secrets → Actions
      #     # For SonarCloud: https://sonarcloud.io
      #     # For self-hosted SonarQube: http://your-sonarqube-server:9000 (or https://your-domain.com)
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      #   run: |
      #     # Check if required secrets are configured
      #     if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
      #       echo "❌ Required Sonar secrets are not configured!"
      #       echo ""
      #       echo "Please configure the following secrets in GitHub:"
      #       echo "1. Go to: Settings → Secrets and variables → Actions"
      #       echo "2. Click 'New repository secret' for each missing secret:"
      #       echo ""
      #       if [ -z "$SONAR_HOST_URL" ]; then
      #         echo "   Secret Name: SONAR_HOST_URL"
      #         echo "   Secret Value:"
      #         echo "     - For SonarCloud: https://sonarcloud.io"
      #         echo "     - For self-hosted SonarQube: http://your-sonarqube-server:9000"
      #         echo ""
      #       fi
      #       if [ -z "$SONAR_TOKEN" ]; then
      #         echo "   Secret Name: SONAR_TOKEN"
      #         echo "   Secret Value: Generate token in SonarCloud/SonarQube:"
      #         echo "     - Go to: My Account → Security → Generate Token"
      #         echo "     - Copy the generated token"
      #         echo ""
      #       fi
      #       exit 1
      #     fi
          
      #     # Run Sonar analysis
      #     # Note: SONAR_TOKEN is automatically used from environment variable by Sonar Maven plugin
      #     # No need to pass it explicitly - the plugin reads SONAR_TOKEN env var automatically
      #     mvn sonar:sonar -Dsonar.host.url=$SONAR_HOST_URL
        # Note: SonarCloud quality gate status is automatically reported via PR checks
        # Configure quality gate in SonarCloud dashboard to fail PRs if not met
        # See: docs/setup-guides/sonarcloud-quality-gate-guide.md
        #
        # Required Secrets:
        # 1. SONAR_HOST_URL - Sonar server endpoint (REQUIRED)
        #    - For SonarCloud: https://sonarcloud.io
        #    - For self-hosted SonarQube: http://your-sonarqube-server:9000
        #    - Passed via: -Dsonar.host.url=$SONAR_HOST_URL
        # 2. SONAR_TOKEN - Authentication token (REQUIRED)
        #    - Generate in SonarCloud/SonarQube: My Account → Security → Generate Token
        #    - Automatically used from environment variable (no need to pass explicitly)
        #    - Sonar Maven plugin reads SONAR_TOKEN env var automatically for authentication
        # 3. SONAR_ORGANIZATION - SonarCloud organization key (optional, auto-detected if not set)

